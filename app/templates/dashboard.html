{% extends "base.html" %}

{% block title %}Dashboard - Cloud Bank Analytics{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-tachometer-alt me-3 text-teal"></i>Dashboard</h1>
        <p>Real-time Account Overview & Transaction Monitoring</p>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card success">
            <div class="metric-label">Account Balance</div>
            <div class="metric-value">${{ "%.2f"|format(account.balance if account else 0) }}</div>
            <small class="text-muted">Available Funds</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card info">
            <div class="metric-label">Total Transactions (30d)</div>
            <div class="metric-value">{{ transactions|length }}</div>
            <small class="text-muted">Last 30 Days</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card warning">
            <div class="metric-label">Monthly Volume</div>
            <div class="metric-value">${{ "%.2f"|format(monthly_volume|default(0)) }}</div>
            <small class="text-muted">Total Transactions</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card danger" id="suspicious-metric">
            <div class="metric-label">Potential Alerts</div>
            <div class="metric-value" id="suspicious-count">0</div>
            <small class="text-muted">Flagged Transactions</small>
        </div>
    </div>
</div>

<!-- Main Content Layout: Sidebar Alerts + Transactions -->
<div class="row">
    <!-- Real-Time Alert System Sidebar -->
    <div class="col-md-4">
        <!-- Compact Alert Widget -->
        <div class="card" style="border-left: 5px solid #E74C3C; position: sticky; top: 20px;">
            <div class="card-header" style="background: linear-gradient(135deg, #FFE5E5 0%, #FFF0F0 100%); color: var(--primary-navy); cursor: pointer;" data-bs-toggle="modal" data-bs-target="#alertsModal">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="color: #E74C3C;">
                        <i class="fas fa-bell me-1"></i>Alerts
                    </h6>
                    <span class="badge bg-danger" id="alert-count">0</span>
                </div>
            </div>
            <div class="card-body p-2" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#alertsModal">
                <div class="text-center text-muted py-2" style="font-size: 0.8rem;">
                    <i class="fas fa-check-circle text-success me-1"></i>
                    <span id="alert-status">All Clear</span>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted" style="font-size: 0.75rem;">Click to view full notifications</small>
                </div>
            </div>
        </div>

        <!-- Quick Actions Section -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('transactions.deposit') }}" class="btn btn-success w-100 mb-2" style="font-size: 0.9rem;">
                    <i class="fas fa-plus-circle me-1"></i>Deposit
                </a>
                <a href="{{ url_for('transactions.withdraw') }}" class="btn btn-warning w-100 mb-2" style="font-size: 0.9rem;">
                    <i class="fas fa-minus-circle me-1"></i>Withdraw
                </a>
                <a href="{{ url_for('transactions.transfer') }}" class="btn btn-info w-100 mb-3" style="font-size: 0.9rem;">
                    <i class="fas fa-exchange-alt me-1"></i>Transfer
                </a>
                <hr>
                <a href="{{ url_for('analytics.dashboard') }}" class="btn btn-primary w-100 mb-2" style="font-size: 0.9rem;">
                    <i class="fas fa-chart-line me-1"></i>Analytics
                </a>
                <a href="{{ url_for('analytics.compliance') }}" class="btn btn-outline-primary w-100" style="font-size: 0.9rem;">
                    <i class="fas fa-shield-alt me-1"></i>Compliance
                </a>
            </div>
        </div>

        <!-- Account Security Info -->
        <div class="card mt-3">
            <div class="card-header" style="background: linear-gradient(135deg, var(--success-green) 0%, #27AE60 100%);">
                <h6 class="mb-0"><i class="fas fa-lock me-2"></i>Security</h6>
            </div>
            <div class="card-body p-3" style="font-size: 0.9rem;">
                <div class="d-flex justify-content-between mb-2">
                    <span>Status:</span>
                    <span class="badge bg-success">Secure</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>2FA:</span>
                    <span class="badge bg-success">Active</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <!-- Recent Transactions Table -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history me-2"></i>Recent Transactions</h5>
            </div>
            <div class="card-body p-0">
                {% if transactions %}
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.created_at[:10] }}</td>
                            <td>
                                {% if transaction.transaction_type == 'deposit' %}
                                    <span class="badge badge-success"><i class="fas fa-arrow-down me-1"></i>Deposit</span>
                                {% elif transaction.transaction_type == 'withdraw' %}
                                    <span class="badge badge-warning"><i class="fas fa-arrow-up me-1"></i>Withdraw</span>
                                {% elif transaction.transaction_type == 'transfer' %}
                                    <span class="badge badge-info"><i class="fas fa-exchange-alt me-1"></i>Transfer</span>
                                {% endif %}
                            </td>
                            <td><strong class="text-success">${{ "%.2f"|format(transaction.amount) }}</strong></td>
                            <td>{{ transaction.description }}</td>
                            <td>
                                {% if transaction.amount > 10000 %}
                                    <span class="badge badge-alert"><i class="fas fa-bell me-1"></i>ALERT</span>
                                {% else %}
                                    <span class="badge badge-success"><i class="fas fa-check me-1"></i>OK</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="p-4 text-center text-muted">
                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                    <p>No transactions yet. Start with a deposit or transfer.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>





<!-- Full Alerts Modal -->
<div class="modal fade" id="alertsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFE5E5 0%, #FFF0F0 100%); border-bottom: 2px solid #E74C3C;">
                <h5 class="modal-title" style="color: #E74C3C;">
                    <i class="fas fa-bell me-2"></i>Real-Time Alert System
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="badge bg-success me-2"><i class="fas fa-circle me-1" style="font-size: 0.6rem;"></i>ACTIVE 24/7</span>
                        <span class="badge bg-danger" id="modal-alert-count">0</span>
                    </div>
                </div>
                <div id="alerts-container-modal" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p class="mt-3 mb-0">No alerts detected - All transactions within normal parameters</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    // Real-time Transaction Monitoring - Fraud Detection Alerts
    document.addEventListener('DOMContentLoaded', function() {
        const transactions = document.querySelectorAll('tbody tr');
        let suspiciousCount = 0;
        let frequencyCount = 0;
        const alertFeed = [];

        transactions.forEach((row, index) => {
            const alertBadge = row.querySelector('.badge-alert');
            if (alertBadge) {
                suspiciousCount++;
                const amount = row.cells[2].textContent.trim();
                const date = row.cells[0].textContent.trim();
                const type = row.cells[1].textContent.trim();

                // Parse amount
                const amountNum = parseFloat(amount.replace('$', '').replace(',', ''));

                // Determine alert type
                let alertType = 'HIGH AMOUNT';
                let alertIcon = 'fa-money-bill';
                let alertText = `${amount} transaction exceeds threshold`;

                if (amountNum > 50000) {
                    alertType = 'CRITICAL AMOUNT';
                    alertIcon = 'fa-exclamation-circle';
                    alertText = `CRITICAL: ${amount} transaction - Manual review required`;
                } else if (amountNum > 25000) {
                    alertType = 'VERY HIGH AMOUNT';
                    alertIcon = 'fa-warning';
                    alertText = `${amount} transaction significantly above average`;
                }

                alertFeed.push({
                    type: alertType,
                    icon: alertIcon,
                    text: alertText,
                    amount: amount,
                    date: date,
                    severity: amountNum > 50000 ? 'critical' : amountNum > 25000 ? 'high' : 'medium'
                });
            }
        });

        // Check for frequency anomalies (multiple transactions in short time)
        if (suspiciousCount > 3) {
            frequencyCount = 1;
            alertFeed.push({
                type: 'FREQUENCY ANOMALY',
                icon: 'fa-hourglass-end',
                text: `${suspiciousCount} high-value transactions detected - Possible velocity attack`,
                amount: '-',
                date: 'Recent',
                severity: 'high'
            });
        }

        // Update alert count and status
        const alertCount = alertFeed.length;
        document.getElementById('alert-count').textContent = alertCount > 0 ? alertCount + ' Alert' + (alertCount !== 1 ? 's' : '') : '0';
        document.getElementById('modal-alert-count').textContent = alertCount > 0 ? alertCount + ' Alert' + (alertCount !== 1 ? 's' : '') : '0';
        document.getElementById('suspicious-count').textContent = suspiciousCount;

        // Update alert status text
        const alertStatus = document.getElementById('alert-status');
        if (alertCount > 0) {
            alertStatus.textContent = `${alertCount} Alert${alertCount !== 1 ? 's' : ''} Detected`;
            alertStatus.previousElementSibling.className = 'fas fa-exclamation-triangle text-warning me-1';
        } else {
            alertStatus.textContent = 'All Clear';
            alertStatus.previousElementSibling.className = 'fas fa-check-circle text-success me-1';
        }

        // Render alerts in modal
        const alertsContainerModal = document.getElementById('alerts-container-modal');
        if (alertFeed.length > 0) {
            alertsContainerModal.innerHTML = '';
            alertFeed.forEach((alert, idx) => {
                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item mb-3 p-3 rounded';
                alertItem.style.borderLeft = `4px solid ${alert.severity === 'critical' ? '#E74C3C' : alert.severity === 'high' ? '#F39C12' : '#3498DB'}`;
                alertItem.style.backgroundColor = alert.severity === 'critical' ? '#FFF5F5' : alert.severity === 'high' ? '#FFFAF0' : '#F0F8FF';

                const badgeColor = alert.severity === 'critical' ? 'bg-danger' : alert.severity === 'high' ? 'bg-warning' : 'bg-info';
                const badgeText = alert.severity === 'critical' ? 'CRITICAL' : alert.severity === 'high' ? 'HIGH' : 'MEDIUM';

                alertItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <span class="badge ${badgeColor} me-2"><i class="fas ${alert.icon} me-1"></i>${badgeText}</span>
                                <span class="badge bg-secondary">${alert.type}</span>
                            </div>
                            <p class="mb-1" style="font-weight: 500; color: #333;">${alert.text}</p>
                            <small class="text-muted"><i class="fas fa-calendar me-1"></i>Detected: ${alert.date}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" style="white-space: nowrap;">
                            <i class="fas fa-search me-1"></i>Review
                        </button>
                    </div>
                `;
                alertsContainerModal.appendChild(alertItem);
            });
        } else {
            alertsContainerModal.innerHTML = `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.3;"></i>
                    <p class="mt-3 mb-0">No alerts detected - All transactions within normal parameters</p>
                </div>
            `;
        }

        if (suspiciousCount > 0) {
            document.getElementById('suspicious-metric').classList.remove('danger');
            document.getElementById('suspicious-metric').classList.add('warning');
        }
    });
</script>
{% endblock %}
