{% extends "base.html" %}

{% block title %}Compliance Dashboard - Cloud Bank Analytics{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-shield-alt me-3 text-teal"></i>Regulatory Compliance Monitoring</h1>
        <p>Real-time Compliance Metrics & Risk Assessment Dashboard</p>
    </div>
</div>

<!-- Scenario 3: Regulatory Compliance Monitoring -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card" style="border-left: 5px solid var(--warning-amber);">
            <div class="card-header" style="background: linear-gradient(135deg, #E8F4F8 0%, #D4E9F7 100%); color: var(--primary-navy);">
                <h5 class="mb-0">
                    <i class="fas fa-gavel me-2"></i>Lisa's Compliance Oversight (Scenario 3)
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <strong>Scenario Overview:</strong> Lisa, a compliance officer, uses this dashboard to ensure the bank meets all regulatory requirements. 
                    She monitors key compliance metrics in real-time and can drill down into underlying data to identify root causes.
                </p>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Monitored Compliance Areas:</h6>
                        <ul>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Transaction Threshold Monitoring</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Suspicious Activity Reporting</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Know Your Customer (KYC) Requirements</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Anti-Money Laundering (AML) Checks</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Corrective Actions Available:</h6>
                        <ul>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Automated alerts for threshold breaches</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Drill-down analytics for investigation</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Immediate action workflow initiation</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Compliance report generation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Status Overview -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-check-double me-2"></i>Overall Compliance Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Compliance Score</h6>
                        <span class="badge {% if compliance_percentage == 100 %}bg-success{% elif compliance_percentage >= 70 %}bg-warning{% else %}bg-danger{% endif %}">
                            {{ compliance_percentage }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        {% if compliance_percentage == 100 %}
                            <div class="progress-bar progress-bar-success" role="progressbar" style="width: {{ compliance_percentage }}%;" aria-valuenow="{{ compliance_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                <strong>{{ compliance_percentage }}%</strong>
                            </div>
                        {% elif compliance_percentage >= 70 %}
                            <div class="progress-bar progress-bar-warning" role="progressbar" style="width: {{ compliance_percentage }}%;" aria-valuenow="{{ compliance_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                <strong>{{ compliance_percentage }}%</strong>
                            </div>
                        {% else %}
                            <div class="progress-bar progress-bar-danger" role="progressbar" style="width: {{ compliance_percentage }}%;" aria-valuenow="{{ compliance_percentage }}" aria-valuemin="0" aria-valuemax="100">
                                <strong>{{ compliance_percentage }}%</strong>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <hr>

                <h6 class="mb-3">Status: 
                    {% if compliance_percentage == 100 %}
                        <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>COMPLIANT</span>
                    {% elif compliance_percentage >= 70 %}
                        <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-circle me-1"></i>AT-RISK</span>
                    {% else %}
                        <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>NON-COMPLIANT</span>
                    {% endif %}
                </h6>

                <p class="text-muted small">{{ compliance_status }}</p>

                <div class="mt-3">
                    <h6>Key Metrics:</h6>
                    <div class="row text-center">
                        <div class="col-sm-4">
                            <div class="border-end">
                                <strong class="d-block text-success">100%</strong>
                                <small class="text-muted">KYC Complete</small>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="border-end">
                                <strong class="d-block text-success">98%</strong>
                                <small class="text-muted">AML Checks</small>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <strong class="d-block {% if compliance_percentage == 100 %}text-success{% else %}text-warning{% endif %}">{{ compliance_percentage }}%</strong>
                            <small class="text-muted">Overall</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bell me-2"></i>Active Alerts & Notifications</h5>
            </div>
            <div class="card-body p-0">
                {% if alerts %}
                    <div class="list-group list-group-flush">
                        {% for alert in alerts %}
                            <div class="list-group-item" style="border-left: 5px solid {% if 'Large transactions' in alert or 'frequent' in alert %}var(--warning-amber){% elif 'Negative' in alert %}var(--danger-red){% else %}var(--success-green){% endif %};">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        {% if 'No compliance' in alert %}
                                            <h6 class="mb-1"><i class="fas fa-check-circle text-success me-2"></i>{{ alert }}</h6>
                                            <small class="text-muted">Detected: Just Now</small>
                                        {% elif 'Large transactions' in alert %}
                                            <h6 class="mb-1"><i class="fas fa-exclamation-triangle text-warning me-2"></i>{{ alert }}</h6>
                                            <small class="text-muted">Action Required: Review large transactions</small>
                                        {% elif 'frequent' in alert %}
                                            <h6 class="mb-1"><i class="fas fa-hourglass-end text-warning me-2"></i>{{ alert }}</h6>
                                            <small class="text-muted">Action Required: Velocity check recommended</small>
                                        {% elif 'Negative' in alert %}
                                            <h6 class="mb-1"><i class="fas fa-times-circle text-danger me-2"></i>{{ alert }}</h6>
                                            <small class="text-muted">Action: URGENT - Immediate review needed</small>
                                        {% else %}
                                            <h6 class="mb-1"><i class="fas fa-info-circle text-info me-2"></i>{{ alert }}</h6>
                                            <small class="text-muted">Status: Monitoring</small>
                                        {% endif %}
                                    </div>
                                    <span class="badge {% if 'No compliance' in alert %}bg-success{% elif 'Negative' in alert %}bg-danger{% else %}bg-warning{% endif %}">
                                        {% if 'No compliance' in alert %}CLEAR{% elif 'Negative' in alert %}CRITICAL{% else %}ALERT{% endif %}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No active alerts</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Regulatory Framework -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-book me-2"></i>Regulatory Framework & Requirements</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-teal"><i class="fas fa-gavel me-2"></i>AML/CFT Compliance</h6>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 100%;"></div>
                            </div>
                            <small class="text-muted">Anti-Money Laundering & Counter Financing of Terrorism</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-teal"><i class="fas fa-id-card me-2"></i>KYC Requirements</h6>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 100%;"></div>
                            </div>
                            <small class="text-muted">Know Your Customer Verification</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-teal"><i class="fas fa-lock me-2"></i>Data Protection</h6>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 99%;"></div>
                            </div>
                            <small class="text-muted">GDPR & Data Privacy Compliance</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <h6 class="text-teal"><i class="fas fa-chart-line me-2"></i>Reporting Standards</h6>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-success" style="width: 98%;"></div>
                            </div>
                            <small class="text-muted">Regulatory Reporting & Filing</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Visualizations -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tachometer-alt me-2"></i>Compliance Summary</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted small">Overall Score</label>
                    <h3 class="text-teal">{{ compliance_percentage }}%</h3>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Status</label>
                    <div>
                        {% if compliance_percentage == 100 %}
                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>COMPLIANT</span>
                        {% elif compliance_percentage >= 70 %}
                            <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-circle me-1"></i>AT-RISK</span>
                        {% else %}
                            <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>NON-COMPLIANT</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list-check me-2"></i>Framework Status</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">AML/CFT Compliance</small>
                    <div class="badge bg-success">100%</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">KYC Requirements</small>
                    <div class="badge bg-success">100%</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">GDPR Compliance</small>
                    <div class="badge bg-success">99%</div>
                </div>
                <div>
                    <small class="text-muted">Reporting Standards</small>
                    <div class="badge bg-success">98%</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Metrics Summary -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation me-2"></i>Active Alert Count</h5>
            </div>
            <div class="card-body">
                <h3 id="active-alert-count">{{ alerts|length if alerts else 0 }}</h3>
                <small class="text-muted">Active alerts requiring attention</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>Risk Level</h5>
            </div>
            <div class="card-body">
                <h3>
                    {% if compliance_percentage >= 90 %}
                        <span class="badge bg-success">LOW</span>
                    {% elif compliance_percentage >= 70 %}
                        <span class="badge bg-warning">MEDIUM</span>
                    {% else %}
                        <span class="badge bg-danger">HIGH</span>
                    {% endif %}
                </h3>
                <small class="text-muted">Overall risk assessment</small>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Alert Analysis -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-microscope me-2"></i>Alert Investigation & Root Cause Analysis</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Real-time Drill-Down Capability:</strong> Click on any alert above to initiate a detailed investigation. The system will provide transaction-level details and recommendations for corrective actions.
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Investigation Tools:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-search text-teal me-2"></i><strong>Transaction Filtering</strong> - Isolate specific transactions by date, amount, or type</li>
                            <li class="mb-2"><i class="fas fa-chart-bar text-teal me-2"></i><strong>Pattern Analysis</strong> - Identify unusual behavior patterns</li>
                            <li class="mb-2"><i class="fas fa-network-wired text-teal me-2"></i><strong>Network Analysis</strong> - Track related accounts and connections</li>
                            <li class="mb-2"><i class="fas fa-file-invoice text-teal me-2"></i><strong>Report Generation</strong> - Create targeted compliance reports</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Corrective Action Process:</h6>
                        <ol class="list-unstyled">
                            <li class="mb-2"><span class="badge bg-primary">1</span> <strong>Identify</strong> - Alert threshold breach detected</li>
                            <li class="mb-2"><span class="badge bg-primary">2</span> <strong>Investigate</strong> - Drill down into transaction data</li>
                            <li class="mb-2"><span class="badge bg-primary">3</span> <strong>Assess</strong> - Evaluate risk level and root cause</li>
                            <li class="mb-2"><span class="badge bg-primary">4</span> <strong>Action</strong> - Initiate corrective measures</li>
                            <li class="mb-2"><span class="badge bg-primary">5</span> <strong>Monitor</strong> - Track resolution and re-monitor</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('transactions.dashboard') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
        <a href="{{ url_for('analytics.dashboard') }}" class="btn btn-outline-primary">
            <i class="fas fa-chart-line me-2"></i>View Analytics
        </a>
        <a href="{{ url_for('analytics.reports') }}" class="btn btn-outline-primary">
            <i class="fas fa-file-alt me-2"></i>Generate Reports
        </a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get compliance percentage from page
        const complianceScoreBadge = document.querySelector('.badge');
        const complianceScore = parseInt(complianceScoreBadge.textContent);
        
        // Initialize all compliance charts
        initializeComplianceCharts(complianceScore);
    });

    function initializeComplianceCharts(complianceScore) {
        // Chart 1: Compliance Score Trend (Line Chart)
        const ctx1 = document.getElementById('complianceScoreChart').getContext('2d');
        const scoreTrendData = generateComplianceTrend(complianceScore);
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: scoreTrendData.labels,
                datasets: [{
                    label: 'Compliance Score %',
                    data: scoreTrendData.scores,
                    borderColor: complianceScore === 100 ? '#2ECC71' : '#F39C12',
                    backgroundColor: complianceScore === 100 ? 'rgba(46, 204, 113, 0.1)' : 'rgba(243, 156, 18, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: complianceScore === 100 ? '#2ECC71' : '#F39C12',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#666', callback: function(value) { return value + '%'; } }
                    },
                    x: { ticks: { color: '#666' } }
                },
                plugins: {
                    legend: { labels: { color: '#333' } }
                }
            }
        });

        // Chart 2: Regulatory Framework Status (Horizontal Bar Chart)
        const ctx2 = document.getElementById('regulatoryStatusChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['AML/CFT', 'KYC', 'GDPR', 'Reporting'],
                datasets: [{
                    label: 'Compliance %',
                    data: [100, 100, 99, 98],
                    backgroundColor: ['#2ECC71', '#2ECC71', '#2ECC71', '#F39C12'],
                    borderColor: ['#27AE60', '#27AE60', '#27AE60', '#E67E22'],
                    borderWidth: 1.5
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: '#666', callback: function(value) { return value + '%'; } }
                    },
                    y: { ticks: { color: '#666' } }
                },
                plugins: {
                    legend: { labels: { color: '#333' } }
                }
            }
        });

        // Chart 3: Alert Distribution (Doughnut Chart)
        const ctx3 = document.getElementById('alertDistributionChart').getContext('2d');
        const alertCounts = calculateAlertCounts();
        new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: ['Large Transactions', 'Frequency Anomalies', 'Balance Threshold', 'Pattern Detection'],
                datasets: [{
                    data: [alertCounts.largeTransactions, alertCounts.frequency, alertCounts.balance, alertCounts.pattern],
                    backgroundColor: ['#F39C12', '#E74C3C', '#E67E22', '#D35400'],
                    borderColor: ['#E67E22', '#C0392B', '#D35400', '#BA4A00'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { labels: { color: '#333', padding: 15 } }
                }
            }
        });

        // Chart 4: Risk Level Assessment (Bar Chart)
        const ctx4 = document.getElementById('riskLevelChart').getContext('2d');
        new Chart(ctx4, {
            type: 'bar',
            data: {
                labels: ['Critical', 'High', 'Medium', 'Low', 'Clear'],
                datasets: [{
                    label: 'Risk Count',
                    data: [0, 2, 5, 12, 81],
                    backgroundColor: ['#E74C3C', '#E67E22', '#F39C12', '#3498DB', '#2ECC71'],
                    borderColor: ['#C0392B', '#D35400', '#E67E22', '#2980B9', '#27AE60'],
                    borderWidth: 1.5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: { color: '#666' }
                    },
                    y: { ticks: { color: '#666' } }
                },
                plugins: {
                    legend: { labels: { color: '#333' } }
                }
            }
        });
    }

    function calculateAlertCounts() {
        // Parse alert elements to count alert types
        const alerts = Array.from(document.querySelectorAll('.list-group-item')).map(el => el.textContent);
        
        let largeTransactions = 0;
        let frequency = 0;
        let balance = 0;
        let pattern = 0;
        
        alerts.forEach(alert => {
            if (alert.includes('Large transactions')) largeTransactions++;
            else if (alert.includes('frequent')) frequency++;
            else if (alert.includes('Negative')) balance++;
            else pattern++;
        });
        
        return { largeTransactions, frequency, balance, pattern };
    }
</script>{% endblock %}