{% extends "base.html" %}

{% block title %}Analytics Dashboard - Cloud Bank Analytics{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1><i class="fas fa-chart-line me-3 text-teal"></i>Analytics Dashboard</h1>
        <p>Real-time Data Analysis & Transaction Insights (Last 30 Days)</p>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card success">
            <div class="metric-label">Total Transactions</div>
            <div class="metric-value">{{ total_transactions }}</div>
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-success" role="progressbar" style="width: 75%;" aria-label="Progress"></div>
            </div>
            <small class="text-muted mt-2 d-block">Trend: <span class="text-success">↑ +12%</span></small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card info">
            <div class="metric-label">Transaction Volume</div>
            <div class="metric-value">${{ "%.0f"|format(total_volume) }}</div>
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-info" role="progressbar" style="width: 65%;" aria-label="Progress"></div>
            </div>
            <small class="text-muted mt-2 d-block">Trend: <span class="text-info">↑ +8%</span></small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card warning">
            <div class="metric-label">Average Transaction</div>
            <div class="metric-value">${{ "%.2f"|format(total_volume / total_transactions if total_transactions > 0 else 0) }}</div>
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-warning" role="progressbar" style="width: 55%;" aria-label="Progress"></div>
            </div>
            <small class="text-muted mt-2 d-block">Value per Transaction</small>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card danger">
            <div class="metric-label">Suspicious Alerts</div>
            <div class="metric-value">{{ suspicious_transactions }}</div>
            <div class="progress mt-3">
                <div class="progress-bar progress-bar-danger" role="progressbar" style="width: {{ [suspicious_transactions * 10, 100]|min }}%;" aria-label="Progress"></div>
            </div>
            <small class="text-muted mt-2 d-block">High-Value Transactions</small>
        </div>
    </div>
</div>

<!-- Scenario 1: Real-time Transaction Monitoring Alert -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card" style="border-left: 5px solid var(--warning-amber);">
            <div class="card-header" style="background: linear-gradient(135deg, #FFF3CD 0%, #FFECB5 100%), linear-gradient(to right, transparent calc(100% - 5px), var(--primary-teal) calc(100% - 5px)); color: #856404;">
                <h5 class="mb-0">
                    <i class="fas fa-hourglass-half me-2"></i>Real-Time Fraud Detection System
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Monitoring Status: <span class="badge badge-success">ACTIVE 24/7</span></h6>
                        <p class="text-muted mb-0">The system continuously monitors all transactions for unusual patterns. Sarah's morning alert routine helps identify potential fraud attempts instantly.</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Detection Methods:</h6>
                        <ul class="list-unstyled small mb-0">
                            <li><i class="fas fa-check-circle text-success me-2"></i>Abnormal amount detection</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Geographic anomaly detection</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Velocity checks (rapid transactions)</li>
                            <li><i class="fas fa-check-circle text-success me-2"></i>Pattern deviation analysis</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Charts Container -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-pie-chart me-2"></i>Transaction Distribution by Type</h5>
            </div>
            <div class="card-body">
                <canvas id="transactionChart" style="max-height: 300px;"></canvas>
                <div class="mt-3 small">
                    <div class="d-flex justify-content-between">
                        <span><span class="badge bg-success me-2"></span>Deposits</span>
                        <strong id="deposit-count">0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><span class="badge bg-warning me-2"></span>Withdrawals</span>
                        <strong id="withdraw-count">0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><span class="badge bg-info me-2"></span>Transfers</span>
                        <strong id="transfer-count">0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bar-chart me-2"></i>Amount Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="amountDistributionChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>
                        <canvas id="alertDistributionChart" style="max-height: 220px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="row mt-4">
    <div class="col-md-12">
        <a href="{{ url_for('analytics.reports') }}" class="btn btn-primary">
            <i class="fas fa-file-alt me-2"></i>Generate Custom Reports (Scenario 2)
        </a>
        <a href="{{ url_for('analytics.compliance') }}" class="btn btn-warning">
            <i class="fas fa-shield-alt me-2"></i>View Compliance Dashboard (Scenario 3)
        </a>
        <a href="{{ url_for('transactions.dashboard') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse transaction data
        const depositCount = {{ transactions | selectattr('transaction_type', 'equalto', 'deposit') | list | length }};
        const withdrawCount = {{ transactions | selectattr('transaction_type', 'equalto', 'withdraw') | list | length }};
        const transferCount = {{ transactions | selectattr('transaction_type', 'equalto', 'transfer') | list | length }};

        // Update counts
        document.getElementById('deposit-count').textContent = depositCount;
        document.getElementById('withdraw-count').textContent = withdrawCount;
        document.getElementById('transfer-count').textContent = transferCount;

        // Chart 1: Transaction Distribution
        const ctx1 = document.getElementById('transactionChart').getContext('2d');
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['Deposits', 'Withdrawals', 'Transfers'],
                datasets: [{
                    data: [depositCount, withdrawCount, transferCount],
                    backgroundColor: ['#2ECC71', '#F39C12', '#3498DB'],
                    borderColor: ['#27AE60', '#E67E22', '#2980B9'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Chart 2: Amount Distribution Bar Chart
        const ctx2 = document.getElementById('amountDistributionChart').getContext('2d');
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['$0-1K', '$1-5K', '$5-10K', '$10K+'],
                datasets: [{
                    label: 'Count',
                    data: [8, 12, 5, {{ suspicious_transactions }}],
                    backgroundColor: ['#2ECC71', '#3498DB', '#F39C12', '#E74C3C'],
                    borderColor: ['#27AE60', '#2980B9', '#E67E22', '#C0392B'],
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    });
</script>

<!-- AWS Integration Note -->
<div class="row mt-5">
    <div class="col-md-12">
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>AWS Infrastructure:</strong> This analytics dashboard leverages Amazon DynamoDB for data storage and AWS EC2 for processing, enabling real-time analysis of banking transactions at scale.
        </div>
    </div>
</div>
{% endblock %}
